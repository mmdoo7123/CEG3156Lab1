LIBRARY ieee;
USE ieee.std_logic_1164.ALL;

ENTITY singleShiftReg9 IS
    PORT(
        i_clock    : IN  STD_LOGIC;
        i_resetBar : IN  STD_LOGIC;
        i_load     : IN  STD_LOGIC; -- Loads the Big ALU Sum
        i_shiftEn  : IN  STD_LOGIC; -- High signal to trigger a single shift
        i_data     : IN  STD_LOGIC_VECTOR(8 DOWNTO 0);
        o_q        : OUT STD_LOG_VECTOR(8 DOWNTO 0)
    );
END singleShiftReg9;

ARCHITECTURE structural OF singleShiftReg9 IS
    -- Required atomic components
    COMPONENT enARdFF_2 IS
        PORT (i_resetBar, i_d, i_enable, i_clock : IN STD_LOGIC; o_q, o_qBar : OUT STD_LOGIC);
    END COMPONENT;

    COMPONENT genericMux2to1 IS
        GENERIC (n : INTEGER := 9);
        PORT (i_A, i_B : IN STD_LOGIC_VECTOR(n-1 DOWNTO 0); i_Sel : IN STD_LOGIC; o_Out : OUT STD_LOGIC_VECTOR(n-1 DOWNTO 0));
    END COMPONENT;

    SIGNAL q_int, d_int, shifted_val : STD_LOG_VECTOR(8 DOWNTO 0);
    SIGNAL w_shiftPulse, q_delayed, q_delayedBar : STD_LOGIC;
    SIGNAL vcc : STD_LOGIC := '1';

BEGIN
    -- 1. Edge Detector (One-Shot Logic)
    -- This ensures only ONE shift occurs even if i_shiftEn stays high
    delay_ff: enARdFF_2
        PORT MAP(
            i_resetBar => i_resetBar,
            i_d        => i_shiftEn,
            i_enable   => vcc,
            i_clock    => i_clock,
            o_q        => q_delayed,
            o_qBar     => q_delayedBar
        );
    
    -- Pulse logic: Signal is high now, but was low last cycle
    w_shiftPulse <= i_shiftEn AND q_delayedBar;

    -- 2. Shift Logic: Concatenate '0' at MSB and drop the LSB
    shifted_val <= '0' & q_int(8 DOWNTO 1);

    -- 3. Input Multiplexer
    -- i_load = '1' selects fresh data from Big ALU
    -- i_load = '0' selects the shifted internal value
    u_mux : genericMux2to1
        GENERIC MAP (n => 9)
        PORT MAP(
            i_A   => shifted_val, -- Select = 0
            i_B   => i_data,      -- Select = 1
            i_Sel => i_load,
            o_Out => d_int
        );

    -- 4. 9-bit Storage Array
    gen_reg: FOR i IN 0 TO 8 GENERATE
        u_ff : enARdFF_2
            PORT MAP(
                i_resetBar => i_resetBar,
                i_d        => d_int(i),
                i_enable   => (i_load OR w_shiftPulse),
                i_clock    => i_clock,
                o_q        => q_int(i),
                o_qBar     => OPEN
            );
    END GENERATE;

    o_q <= q_int;

END structural;